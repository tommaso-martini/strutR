% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/strut.R
\name{struthers_redistr_under}
\alias{struthers_redistr_under}
\title{Infiltration-redistribution-drainage step (Struthers-style fronts)}
\usage{
struthers_redistr_under(
  fronts,
  theta_r,
  theta_s,
  beta,
  Ks,
  L = 2,
  delta = 0,
  f_t,
  dt_sub = 1,
  infill_all = FALSE,
  debug = FALSE,
  theta_field_capacity = NA_real_,
  Z_1 = NA_real_,
  tol_merge = 1e-06,
  solver_max_iter = 20,
  solver_tol_theta = 1e-08,
  solver_max_halvings = 2
)
}
\arguments{
\item{fronts}{list of fronts, each \code{list(theta=..., x=...)} (at least one).}

\item{theta_r, theta_s}{residual and saturation water contents (-).}

\item{beta}{Brooks-Corey shape parameter used in \eqn{K(\theta)}.}

\item{Ks}{saturated hydraulic conductivity \link{m/day}.}

\item{L}{total soil depth \link{m}.}

\item{delta}{geometric offset above the first stored layer \link{m}.}

\item{f_t}{imposed top flux \link{m/day} for this sub-step.}

\item{dt_sub}{sub-step duration \link{day}.}

\item{infill_all}{logical; if \code{TRUE} all \eqn{f_t} is injected at the
shallowest layer in one fixed update (debug/compatibility mode).}

\item{debug}{logical; if \code{TRUE} prints detailed diagnostics.}

\item{theta_field_capacity, Z_1}{kept for backward compatibility (unused here).}

\item{tol_merge}{merging tolerance for fronts.}

\item{solver_max_iter, solver_tol_theta, solver_max_halvings}{Picard controls
and time-halving retry budget used when \code{infill_all=FALSE}.}
}
\value{
A list with
\itemize{
\item \code{fronts}: updated fronts after post-merge;
\item \code{fronts_infil}: snapshot of fronts immediately after the
"geometric" infiltration and pre-merge (useful for plotting);
\item \code{drainage}: deep drainage volume \link{m} released in this sub-step.
}
}
\description{
Advances the Struthers front-based soil column by one sub-step under a given
top flux \eqn{f_t}, performing (i) possible creation of a new top front,
(ii) pre-merge of adjacent fronts, (iii) simultaneous update of \eqn{\theta}
at all fronts via a Picard solve, (iv) update of the front depths \eqn{x} by
exact storage balance, (v) post-merge, and (vi) deep drainage on the
shallowest (topmost) front with clamping \eqn{x\le L}.
}
\details{
\strong{Step order (faithful to the i-r-d sequence in the original formulation)}
\enumerate{
\item \emph{Optional new top front:} if \eqn{f_t > K(\theta_\mathrm{top})}, create a
thin head-front at \eqn{x\approx \delta} with
\eqn{\theta_\mathrm{new} = \theta_r + (\theta_s-\theta_r)(f_t/K_s)^\beta}.
\item \emph{Pre-merge:} merge negligible layers (tolerance \code{tol_merge}).
\item \emph{Simultaneous \eqn{\theta} solve:} use Picard iteration
(\code{.solve_q_step_picard}) unless \code{infill_all=TRUE}, in which case
all the boundary flux is imposed at the topmost layer for one fixed update.
\item \emph{Update front depths:} from exact mass balance (Eq. 1 in code comments),
using previous and updated \eqn{\theta}.
\item \emph{Apply state and post-merge:} write back \eqn{\theta,x} and merge again.
\item \emph{Deep drainage:} only on the shallowest stored layer; excess thickness
\eqn{x_1-L} is converted into drainage volume proportional to the local
contrast in \eqn{\theta} and \eqn{x_1} is clamped to \eqn{L}.
}

Field capacity corrections are intentionally \strong{not} applied here to keep the
sequencing faithful to i-r-d; if desired, they should be applied \emph{after}
redistribution/merge and \emph{before} ET at the caller level.
}
\examples{
## Minimal call (using predefined Kfun, merging, f_euler utilities):
# out <- struthers_redistr_under(fronts, theta_r=0.05, theta_s=0.45, beta=1/8,
#                                Ks=1.0, L=2.0, delta=0.2, f_t=0.01, dt_sub=1/24)
}
\references{
Struthers-style front models for infiltration-redistribution-drainage;
Brooks, R.H. & Corey, A.T. (1966) \emph{Hydraulic properties of porous media}.
}
\seealso{
\code{\link{.solve_q_step_picard}}
}
